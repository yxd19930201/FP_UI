
# -*- coding: utf-8 -*-

# Form implementation generated from reading ui file 'fp_win.ui'
#
# Created by: PyQt5 UI code generator 5.15.4
#
# WARNING: Any manual changes made to this file will be lost when pyuic5 is
# run again.  Do not edit this file unless you know what you are doing.
import datetime
import base64
import paramiko
import subprocess
import ctypes
import hashlib
import json
import random
import re
import socket
import subprocess
import time
import uuid
import mysql.connector
import pymysql
import requests
from PyQt5 import QtCore, QtWidgets,QtGui
import sys
import pymssql
import subprocess
import ctypes
from datetime import datetime, timedelta
import platform





class Ui_Dialog(object):
    head = {"Content-Type": "application/x-www-form-urlencoded",
            "Cookie": "XXL_JOB_LOGIN_IDENTITY=6333303830376536353837616465323835626137616465396638383162336437"}

    def setupUi(self, Dialog):
        Dialog.setObjectName("Dialog")
        Dialog.resize(1031, 606)
        self.pushButton = QtWidgets.QPushButton(Dialog)
        self.pushButton.setGeometry(QtCore.QRect(60, 40, 130, 51))
        self.pushButton.setObjectName("pushButton")
        self.pushButton.clicked.connect(self.get_log_range)
        self.textBrowser = QtWidgets.QTextBrowser(Dialog)
        self.lineEdit_1 = QtWidgets.QLineEdit(Dialog)
        self.lineEdit_1.setGeometry(QtCore.QRect(200, 40, 180, 51))
        self.textBrowser.setGeometry(QtCore.QRect(50, 200, 941, 361))
        self.textBrowser.setObjectName("textBrowser")
        self.pushButton_2 = QtWidgets.QPushButton(Dialog)
        self.pushButton_2.setGeometry(QtCore.QRect(800, 40, 121, 51))
        self.pushButton_2.setObjectName("pushButton_2")
        self.pushButton_2.clicked.connect(self.run_task)
        self.pushButton_3 = QtWidgets.QPushButton(Dialog)
        self.pushButton_3.setGeometry(QtCore.QRect(400, 40, 100, 51))
        self.pushButton_3.setObjectName("pushButton_2")
        self.pushButton_3.clicked.connect(self.connect_to_mysql)

        self.comboBox = QtWidgets.QComboBox(Dialog)
        self.comboBox.setGeometry(QtCore.QRect(600, 40, 191, 51))
        self.comboBox.setObjectName("comboBox")
        self.comboBox.addItem("万里牛-发货同步")
        self.comboBox.addItem("万里牛-售后同步")
        self.comboBox.addItem("快递鸟-签收同步")
        self.comboBox.addItem("core--初始账单")
        self.comboBox.addItem("core--余额打款")
        self.comboBox.addItem("core--现金打款")
        self.comboBox.addItem("core--打款查询")
        self.comboBox.addItem("订单推送活动及MQ")
        self.comboBox.addItem("同步分销商注册")
        self.comboBox.addItem("处理活动的启停")
        self.comboBox.addItem("活动扫描发放奖励")
        self.comboBox.addItem("伊利--群答题任务")
        self.comboBox.addItem("伊利--群抽奖任务")
        self.comboBox.addItem("伊利--执行会话存档")

        self.pushButton_4 = QtWidgets.QPushButton(Dialog)
        self.pushButton_4.setGeometry(QtCore.QRect(60, 120, 130, 51))
        self.pushButton_4.setObjectName("pushButton_4")


        self.comboBox_4 = QtWidgets.QComboBox(Dialog)
        self.comboBox_4.setGeometry(QtCore.QRect(200, 120, 180, 51))
        self.comboBox_4.setObjectName("comboBox_4")
        self.comboBox_4.addItem("华润测试环境")

        self.pushButton_5 = QtWidgets.QPushButton(Dialog)
        self.pushButton_5.setGeometry(QtCore.QRect(400, 120, 100, 51))
        self.pushButton_5.setObjectName("pushButton_5")
        self.pushButton_5.clicked.connect(self.check_website)

        self.pushButton_6 = QtWidgets.QPushButton(Dialog)
        self.pushButton_6.setGeometry(QtCore.QRect(600, 120, 200, 51))
        self.pushButton_6.setObjectName("pushButton_6")
        self.pushButton_6.clicked.connect(self.hr_token)


        self.retranslateUi(Dialog)
        QtCore.QMetaObject.connectSlotsByName(Dialog)

    def retranslateUi(self, Dialog):
        _translate = QtCore.QCoreApplication.translate
        Dialog.setWindowTitle(_translate("Dialog", "契胜测试工具V2"))
        self.pushButton.setText(_translate("Dialog", "克缇获取服务日志"))
        self.pushButton_2.setText(_translate("Dialog", "执行任务"))
        self.pushButton_3.setText(_translate("Dialog", "获取订单状态"))
        self.pushButton_4.setText(_translate("Dialog", "选择网络环境"))
        self.pushButton_5.setText(_translate("Dialog", "点击检查网络"))
        self.pushButton_6.setText(_translate("Dialog", "一键获取华润token"))

        self.comboBox.setItemText(0, _translate("Dialog", "万里牛-发货同步"))
        self.comboBox.setItemText(1, _translate("Dialog", "万里牛-售后同步"))
        self.comboBox.setItemText(2, _translate("Dialog", "快递鸟-签收同步"))
        self.comboBox.setItemText(3, _translate("Dialog", "core--初始账单"))
        self.comboBox.setItemText(4, _translate("Dialog", "core--余额打款"))
        self.comboBox.setItemText(5, _translate("Dialog", "core--现金打款"))
        self.comboBox.setItemText(6, _translate("Dialog", "core--打款查询"))
        self.comboBox.setItemText(7, _translate("Dialog", "订单推送活动及MQ"))
        self.comboBox.setItemText(8, _translate("Dialog", "同步分销商注册"))
        self.comboBox.setItemText(9, _translate("Dialog", "处理活动的启停"))
        self.comboBox.setItemText(10, _translate("Dialog", "活动扫描发放奖励"))
        self.comboBox.setItemText(11, _translate("Dialog", "伊利--群答题任务"))
        self.comboBox.setItemText(12, _translate("Dialog", "伊利--群抽奖任务"))
        self.comboBox.setItemText(13, _translate("Dialog", "伊利--执行会话存档"))

        self.comboBox_4.setItemText(14, _translate("Dialog", "华润测试环境"))



    def get_today_range(self):
        # 获取当前日期
        today = datetime.today().date()

        # 构造当天开始时间和结束时间
        start_of_day = datetime.combine(today, datetime.min.time())
        end_of_day = start_of_day + timedelta(days=1) - timedelta(seconds=1)

        # 格式化为指定字符串格式
        start_str = start_of_day.strftime('%Y-%m-%d 00:00:00')
        end_str = end_of_day.strftime('%Y-%m-%d 23:59:59')

        return start_str + ' - ' + end_str

    def run_task(self):
        url_kt= 'http://172.19.0.133:8080/xxl-job-admin/jobinfo/trigger'
        head_kt={"Content-Type": "application/x-www-form-urlencoded",
                   "Cookie": "XXL_JOB_LOGIN_IDENTITY=6333303830376536353837616465323835626137616465396638383162336437"}
        url_yl = 'https://ylewxapi-test.yili.com/ewx/xxljob/jobinfo/trigger'
        head_yl = {"Content-Type": "application/x-www-form-urlencoded",
                   "Cookie": "XXL_JOB_LOGIN_IDENTITY=7b226964223a312c22757365726e616d65223a2261646d696e222c2270617373776f7264223a226231643034373035653734393039646232376438373063386261313561326138222c22726f6c65223a312c227065726d697373696f6e223a6e756c6c7d"}

        try:

            if self.comboBox.currentText()=="万里牛-发货同步":
                head = head_kt
                url=url_kt
                jobGroup=5
                id=25
                data={"id":25,
                      "executorParam":id}
            elif self.comboBox.currentText()=="万里牛-售后同步":
                head = head_kt
                url = url_kt
                jobGroup = 5
                id=26
                data={"id":26,
                      "executorParam":id}
            elif self.comboBox.currentText()=="快递鸟-签收同步":
                head = head_kt
                url = url_kt
                jobGroup = 5
                id=43
                data={"id":43,
                      "executorParam":id}
            elif self.comboBox.currentText()=="core--初始账单":
                head = head_kt
                url = url_kt
                jobGroup = 7
                id=41
                data={"id":41,
                      "executorParam":id}
            elif self.comboBox.currentText()=="core--余额打款":
                head = head_kt
                url = url_kt
                jobGroup = 7
                id=38
                data={"id":38,
                      "executorParam":id}
            elif self.comboBox.currentText()=="core--现金打款":
                head = head_kt
                url = url_kt
                jobGroup = 7
                id=40
                data={"id":40,
                      "executorParam":id}
            elif self.comboBox.currentText()=="core--打款查询":
                head = head_kt
                url = url_kt
                jobGroup = 7
                id=42
                data={"id":42,
                      "executorParam":id}
            elif self.comboBox.currentText()=="订单推送活动及MQ":
                head = head_kt
                url = url_kt
                jobGroup = 7
                id=55
                data={"id":55,
                      "executorParam":id}
            elif self.comboBox.currentText()=="同步分销商注册":
                head = head_kt
                url = url_kt
                jobGroup = 7
                id = 53
                data={"id":53,
                      "executorParam":id}
            elif self.comboBox.currentText()=="处理活动的启停":
                head = head_kt
                url = url_kt
                jobGroup = 7
                id = 52
                data={"id":52,
                      "executorParam":id}
            elif self.comboBox.currentText()=="活动扫描发放奖励":
                head = head_kt
                url = url_kt
                jobGroup = 7
                id = 51
                data={"id":51,
                      "executorParam":id}

            elif self.comboBox.currentText()=="伊利--群答题任务":
                head = head_yl
                url = url_yl
                jobGroup = 2
                id = 99
                data={"id":99,
                      "executorParam":"群答题任务",
                      "addressList":None}

            elif self.comboBox.currentText()=="伊利--群抽奖任务":
                head = head_yl
                url = url_yl
                jobGroup = 2
                id = 98
                data={"id":98,
                      "executorParam":"群抽奖任务",
                      "addressList":None}

            elif self.comboBox.currentText()=="伊利--执行会话存档":
                head = head_yl
                url = url_yl
                jobGroup = 2
                id = 100
                data={"id":100,
                      "executorParam":"执行会话存档",
                      "addressList":None}


            task=requests.post(url,data=data,headers=head,verify=False)
            task_code=task.json()["code"]
            time.sleep(2)

            if id in(25,26,43,41,38,40,42,55,53,52,51):
                url = 'http://172.19.0.133:8080/xxl-job-admin/joblog/pageList'

                data = {"jobGroup": jobGroup,
                        "jobId": id,
                        "logStatus": -1,
                        "filterTime": self.get_today_range(),
                        "start": 0,
                        "length": "10",
                        }

            elif id in(99,98,100):
                url = 'https://ylewxapi-test.yili.com/ewx/xxljob/joblog/pageList'
                data = {"jobGroup": jobGroup,
                        "jobId": id,
                        "logStatus": -1,
                        "filterTime": self.get_today_range(),
                        "start": 0,
                        "length": "1",
                        }


            status_log=requests.post(url,data=data,headers=head,verify=False)
            code=status_log.json()['data'][0]['handleCode']
            while code==0 or code==500 or code is None:
                time.sleep(2)
                status_log = requests.post(url, data=data, headers=head,verify=False)
                code = status_log.json()['data'][0]['handleCode']

            current_timestamp = int(time.time())

            if task_code==200 and code==200:
                self.textBrowser.append("任务执行成功{}".format(current_timestamp))
            else:
                self.textBrowser.append("任务执行失败{}".format(current_timestamp))



        except Exception as e:
            self.textBrowser.append(e)
        finally:
            self.textBrowser.append("********************")





    def get_log_range(self):
        # SSH 连接信息
        hostname = '172.19.0.128'
        port = 9998  # 默认 SSH 端口是 22
        username = 'root'
        password = 'ppxcx@123'

        # 创建 SSH 客户端对象
        client = paramiko.SSHClient()
        client.set_missing_host_key_policy(paramiko.AutoAddPolicy())

        order_no=self.lineEdit_1.text()
        try:

            # 连接服务器
            client.connect(hostname, port=port, username=username, password=password)

            # 执行远程命令示例，例如 grep -r 搜索日志文件
            command = "grep -r '\"masterOrderSn\":\"{}\"' /data/miya/order/logs/app".format(order_no)
            stdin, stdout, stderr = client.exec_command(command)

            # 读取命令输出
            output = stdout.read().decode()
            error = stderr.read().decode()

            # 打印输出结果
            if output:
                self.textBrowser.append("Command output:")
                self.textBrowser.append(output)
            if error:
                self.textBrowser.append("Command error:")
                self.textBrowser.append(error)


        finally:
            # 关闭 SSH 连接
            client.close()

    def connect_to_mysql(self):
        order_no = self.lineEdit_1.text()
        host = 'rm-bp1fts3bsss2x4q98qo.mysql.rds.aliyuncs.com'
        database = 'wuhan_kntn'
        port = 3637
        user = 'wuhan_kntn_test'
        password = 'wuhan_kn1tn_te@st'

        # 创建 MySQL 连接
        try:
            conn = mysql.connector.connect(
                host=host,
                database=database,
                port=port,
                user=user,
                password=password
            )

            if conn.is_connected():
                print('Connected to MySQL database')

                # 执行 SQL 查询
                cursor = conn.cursor()
                query = "SELECT bill_amount,bill_staus FROM ke_bill_info WHERE order_code='{}'".format(order_no)  # 替换为你的实际查询和表名

                cursor.execute(query)

                # 获取查询结果
                for (bill_amount, bill_staus) in cursor:
                    if bill_staus == 0:
                        self.textBrowser.append(f'金额: {bill_amount}, 状态: ''初始化状态:0')
                    elif bill_staus == 1:
                        self.textBrowser.append(f'金额: {bill_amount}, 状态: ''待打款:1')
                    elif bill_staus == 5:
                        self.textBrowser.append(f'金额: {bill_amount}, 状态: ''余额成功:5')
                    elif bill_staus == 4:
                        self.textBrowser.append(f'金额: {bill_amount}, 状态: ''现金成功:4')
                    elif bill_staus == 2:
                        self.textBrowser.append(f'金额: {bill_amount}, 状态: ''已打款:2')
                    else:
                        self.textBrowser.append(f'金额: {bill_amount}, 状态: ''未知状态:')

        except mysql.connector.Error as e:
            self.textBrowser.append(f'Error connecting to MySQL: {e}')

        finally:
            # 关闭连接
            if 'conn' in locals() and conn.is_connected():
                cursor.close()
                conn.close()
                self.textBrowser.append('MySQL connection closed')

    def check_website(self):
        url = 'http://bmp-uat.crv.com.cn'
        try:
            response = requests.get(url)
            # 检查返回状态码是否为 200（成功）
            if response.status_code == 200:
                self.textBrowser.append(f"网站 {url} 可以访问。")
            else:
                self.textBrowser.append(f"网站 {url} 返回状态码: {response.status_code}。")
        except requests.RequestException as e:
            self.textBrowser.append(f"访问网站 {url} 时发生错误: {e}")


    def login_bmp(self):
        input_string = "Zhangrui@01"
        byte_data = input_string.encode('utf-8')
        # 使用 Base64 编码
        base64_bytes = base64.b64encode(byte_data)
        # 将编码结果转换为字符串
        password=base64_bytes.decode('utf-8')

        url='https://bmp-uat.crv.com.cn/api/fea-bmp/authentication/login?grant_type=password'
        data={"account":"miya-14","password":password,"terminal":"PC-WEB","entId":1,"loginAppId":1000,"crv_uuid":"73e5c88b-696c-00a1-9045-851bd0196ace"}
        head={"Content-Type": "application/json"}
        bmp=requests.post(url,data=json.dumps(data),headers=head,verify=False)
        self.bmp_token=bmp.json()['data']['access_token']
        print(self.bmp_token)
        return  self.bmp_token


    def hr_token(self):
        WEBHOOK_URL = "https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=4b26e99e-a7fb-4e6d-aab6-61a82ede9539"

        url='https://bmp-uat.crv.com.cn/api/fea-bmp/authentication/application/apply'
        data={"entId":1,"appId":100000102}
        head={"Content-Type": "application/json",
              "ssotoken": self.login_bmp()}
        token=requests.post(url,data=json.dumps(data),headers=head,verify=False)
        self.token_hr=token.json()['data']['access_token']
        self.text=(f"获取到的华润UAT环境token为：{self.token_hr}，"
              f"拼接后的URL地址：https://ewop-uat.crv.com.cn/?appToken={self.token_hr}")
        print(self.text)
        self.textBrowser.append(self.text)
        self.textBrowser.append('********************')
        MESSAGE = {
            "msgtype": "text",
            "text": {
                "content": self.text}
            }

        response = requests.post(WEBHOOK_URL, json=MESSAGE)
        if response.status_code == 200:
            print("提醒消息发送成功")
        else:
            print(f"提醒消息发送失败，状态码: {response.status_code}, 响应内容: {response.text}")














    def dual_num(self, str):
            try:
                num = float(str)
            except Exception as e:
                num = 0
            return num


if __name__ == '__main__':
    app = QtWidgets.QApplication(sys.argv)
    MainWindow = QtWidgets.QWidget()
    ui = Ui_Dialog()
    ui.setupUi(MainWindow)
    MainWindow.show()
    sys.exit(app.exec_())










